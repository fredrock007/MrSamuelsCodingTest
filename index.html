<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Disa Moodle Style Quiz ‚Ä¢ 100 Questions</title>

  <style>
    :root{--bg:#f5f6f8;--surface:#fff;--text:#1f2937;--muted:#6b7280;--border:#dfe3ea;--brand:#b11226;--brand-2:#8f0e1e;--ok:#1b7f3b;--bad:#b42318;--warn:#b45309;--shadow:0 10px 28px rgba(17,24,39,.10);--radius:14px;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);line-height:1.4}
    .topbar{background:linear-gradient(180deg,var(--brand) 0%,var(--brand-2) 100%);color:#fff;padding:16px 18px;position:sticky;top:0;z-index:20;box-shadow:0 6px 18px rgba(0,0,0,.18)}
    .topbar-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{height:140px;width:auto;display:block;object-fit:contain}
    .logo img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 8px 18px rgba(0,0,0,.25))}
    .brand h1{font-size:22px;margin:0;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.2px}
    .brand .sub{font-size:13px;color:rgba(255,255,255,.88);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .timer-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .timer-pill{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid rgba(255,255,255,.30);background:rgba(255,255,255,.14);border-radius:999px;font-weight:950;white-space:nowrap;backdrop-filter:blur(6px)}
    .timer-pill .label{font-weight:850;color:rgba(255,255,255,.90);font-size:12px}
    .timer-pill .time{font-family:var(--mono);font-size:15px;color:#fff}
    .timer-pill.warn{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.38)}
    .timer-pill.danger{background:rgba(255,255,255,.22);border-color:rgba(255,255,255,.50)}
    .credits{font-size:11px;color:rgba(255,255,255,.86)}
    .wrap{max-width:1100px;margin:18px auto 64px;padding:0 14px;display:grid;grid-template-columns:320px 1fr;gap:14px}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}
    .side{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;position:sticky;top:86px;align-self:start}
    @media (max-width:980px){.side{position:static}}
    .side-head{padding:14px 14px 10px;border-bottom:1px solid var(--border);background:#fbfcfe}
    .side-title{margin:0;font-size:14px;font-weight:1000}
    .side-sub{margin:6px 0 0;font-size:12px;color:var(--muted)}
    .ident{padding:12px 14px;border-bottom:1px solid var(--border);display:grid;gap:10px}
    .field label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    .field input,.field select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);outline:none;background:#fff;font-size:14px}
    .field input:focus,.field select:focus{border-color:rgba(15,108,191,.45);box-shadow:0 0 0 4px rgba(15,108,191,.12)}
    .nav{padding:12px 14px 14px}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--muted);margin-bottom:10px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.todo{background:#cbd5e1}.dot.done{background:var(--ok)}.dot.flag{background:var(--warn)}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .qbtn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 0;font-weight:1000;cursor:pointer;transition:transform .03s ease}
    .qbtn:active{transform:scale(.99)}
    .qbtn.done{border-color:rgba(27,127,59,.35);background:rgba(27,127,59,.06);color:var(--ok)}
    .qbtn.flag{border-color:rgba(180,83,9,.35);background:rgba(180,83,9,.08);color:var(--warn)}
    .qbtn.current{outline:3px solid rgba(15,108,191,.18);border-color:rgba(15,108,191,.45)}
    .side-actions{padding:12px 14px 14px;border-top:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap;background:#fbfcfe}
    .main{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .main-head{padding:16px 18px;border-bottom:1px solid var(--border);background:#fbfcfe}
    .main-title{margin:0;font-size:18px;font-weight:1000}
    .main-sub{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .panel{padding:14px 18px 18px}
    .qcard{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;background:#fff}
    .qhead{padding:14px 14px 10px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start;background:#fafcff;border-bottom:1px solid var(--border)}
    .qnum{font-weight:1000;color:#0b2d4c}
    .qpts{font-size:12px;color:var(--muted);white-space:nowrap;margin-top:2px}
    .qtext{font-weight:850;margin-top:6px}
    .qbody{padding:10px 14px 14px}
    .opt{display:flex;gap:10px;padding:10px;border-radius:12px;cursor:pointer}
    .opt:hover{background:#f1f7ff}
    .opt input{margin-top:3px}
    .opt span{flex:1}
    .tools{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:1000;cursor:pointer;font-size:14px}
    .primary{background:var(--brand);color:#fff}.primary:hover{filter:brightness(.96)}
    .ghost{background:#fff;border:1px solid var(--border);color:var(--text)}.ghost:hover{background:#fafafa}
    .danger{background:#fff;border:1px solid rgba(180,35,24,.25);color:var(--bad)}.danger:hover{background:#fff5f5}
    .small{font-size:12px;color:var(--muted)}
    .flagbtn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px;font-weight:1000;cursor:pointer}
    .flagbtn.flagged{border-color:rgba(180,83,9,.35);background:rgba(180,83,9,.08);color:var(--warn)}
    .result{margin-top:14px;border:1px solid var(--border);border-radius:var(--radius);padding:14px;background:#fbfcff}
    .score{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .score .big{font-size:20px;font-weight:1000}
    .badge{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;font-weight:1000;font-size:12px;border:1px solid var(--border);background:#fff}
    .badge.ok{color:var(--ok);border-color:rgba(27,127,59,.25);background:rgba(27,127,59,.06)}
    .badge.bad{color:var(--bad);border-color:rgba(180,35,24,.25);background:rgba(180,35,24,.06)}
    details.review{margin-top:12px}
    details.review summary{cursor:pointer;font-weight:1000;color:#0b2d4c}
    .review-list{margin:10px 0 0;padding-left:18px}
    .review-list li{margin:10px 0}
    .correct{color:var(--ok);font-weight:1000}
    .wrong{color:var(--bad);font-weight:1000}
    @media print{.topbar,.side,.tools,.flagbtn,#toastLayer,.fxOverlay{display:none!important}body{background:#fff}.wrap{grid-template-columns:1fr}.main{box-shadow:none}}
    /* ----- Toast + FX ----- */
    #toastLayer{position:fixed;inset:0;pointer-events:none;z-index:9999}
    #toastBox{position:absolute;left:50%;top:14px;transform:translateX(-50%);width:min(560px,calc(100% - 28px));pointer-events:none}
    .toast{pointer-events:auto;background:rgba(255,255,255,.96);border:1px solid rgba(223,227,234,.95);box-shadow:0 18px 46px rgba(17,24,39,.18);border-radius:18px;padding:14px 16px;display:flex;gap:12px;align-items:flex-start;backdrop-filter:blur(8px)}
    .toast .tTitle{font-weight:1000;font-size:15px;margin:0;color:#0b2d4c}
    .toast .tMeta{margin:4px 0 0;font-size:13px;color:var(--muted)}
    .toast .tScore{font-family:var(--mono);font-weight:1000;font-size:14px;color:#0b2d4c;margin-top:8px}
    .toast .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;font-weight:1000;font-size:12px;border:1px solid var(--border);background:#fff}
    .toast .pill.ok{color:var(--ok);border-color:rgba(27,127,59,.25);background:rgba(27,127,59,.06)}
    .toast .pill.bad{color:var(--bad);border-color:rgba(180,35,24,.25);background:rgba(180,35,24,.06)}
    .toast .emoji{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(180deg,rgba(177,18,38,.12),rgba(143,14,30,.06));border:1px solid rgba(177,18,38,.18);font-size:20px}
    .toast-enter{animation:toastIn .25s ease-out both}
    @keyframes toastIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    .toast-blur-exit{animation:toastBlurOut .35s ease-in both}
    @keyframes toastBlurOut{0%{opacity:1;filter:blur(0);transform:translateY(0)}100%{opacity:0;filter:blur(8px);transform:translateY(-12px)}}
    .confettiLayer{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:9998}
    .confettiPiece{position:absolute;top:-14px;width:10px;height:16px;border-radius:3px;opacity:.95;transform:translateY(0) rotate(0deg);animation:confettiFall var(--dur) linear var(--delay) both}
    @keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg)}100%{transform:translateY(110vh) rotate(720deg)}}
    .fxOverlay{position:fixed;inset:0;display:none;pointer-events:none;z-index:10000;background:radial-gradient(1200px 800px at 50% 20%,rgba(255,255,255,.12),rgba(0,0,0,.62))}
    .fxOverlay.show{display:block;animation:fxIn .25s ease-out both}
    @keyframes fxIn{from{opacity:0}to{opacity:1}}
    #fxCanvas{position:absolute;inset:0;width:100%;height:100%}
    .congrats{position:absolute;left:50%;top:58%;transform:translate(-50%,-50%);text-align:center;font-weight:1000;letter-spacing:.5px;line-height:1}
    .congrats .big{font-size:min(88px,12vw);background:linear-gradient(180deg,#ffeaa0 0%,#ffd24a 50%,#c99200 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 16px 44px rgba(0,0,0,.35)}
    .congrats.rise{animation:rise 10s ease-out both}
    @keyframes rise{0%{opacity:0;transform:translate(-50%,-40%)}15%{opacity:1}100%{opacity:1;transform:translate(-50%,-64%)}}
  </style>

  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">
        <img src="disa-logo.png" alt="Disa Primary School Logo"/>
      </div>
      <div style="min-width:0">
        <h1 id="courseTitle">Course: Coding &amp; Robotics</h1>
        <div class="sub" id="quizTitle">Quiz: (100 Questions)</div>
      </div>
    </div>
    <div class="timer-wrap">
      <div class="timer-pill" id="timerPill" title="Timer counts down. Auto-submits at 0.">
        <span class="label">Time left</span><span class="time" id="timer">35:00</span>
      </div>
      <div class="credits">¬© MR SAMUELS</div>
    </div>
  </div>
</header>

<main class="wrap">
  <aside class="side" aria-label="Quiz navigation">
    <div class="side-head">
      <p class="side-title">Quiz navigation</p>
      <p class="side-sub">Total: <strong id="totalQ">100</strong> questions ‚Ä¢ Auto-submit at 0</p>
    </div>

    <div class="ident">
      <div class="field">
        <label for="classSelect">Class</label>
        <select id="classSelect">
          <option value="">Select class...</option>
        </select>
      </div>

      <div class="field">
        <label for="learnerSelect">Learner</label>
        <select id="learnerSelect" disabled>
          <option value="">Select learner...</option>
        </select>
      </div>

      <div class="small" id="gradeLine">Grade: ‚Äî</div>

      <!-- Hidden mirrors so your result text stays the same style -->
      <input id="learnerName" type="hidden"/>
      <input id="className" type="hidden"/>
    </div>

    <div class="nav">
      <div class="legend">
        <span><span class="dot todo"></span> Not answered</span>
        <span><span class="dot done"></span> Answered</span>
        <span><span class="dot flag"></span> Flagged</span>
      </div>
      <div class="grid" id="navGrid" aria-label="Question grid"></div>
    </div>

    <div class="side-actions">
      <button class="ghost" id="saveBtn" title="Save progress on this device.">Save</button>
      <button class="danger" id="resetBtn" title="Reset attempt (clears this device only).">Reset</button>
    </div>
  </aside>

  <section class="main">
    <div class="main-head">
      <p class="main-title" id="mainTitle">Attempt: Coding &amp; Robotics MCQ (100 Questions)</p>
      <p class="main-sub" id="mainSub">Rules: Silent work. No talking. Auto-submit when time runs out.</p>
    </div>

    <div class="panel">
      <div class="qcard" id="qcard"></div>

      <div class="tools">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="ghost" id="prevBtn" title="Go to the previous question.">Previous</button>
          <button class="ghost" id="nextBtn" title="Go to the next question.">Next</button>
          <button class="flagbtn" id="flagBtn" title="Flag this question to review later.">‚öë Flag question</button>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="ghost" id="finishAttemptBtn" title="Shows unanswered/flagged summary (does not submit).">Finish attempt</button>
          <button class="primary" id="submitBtn" title="Submit your answers and finish the quiz.">Submit all and finish</button>
        </div>
      </div>

      <div class="result" id="result" style="display:none"></div>
    </div>
  </section>
</main>

<div id="toastLayer" aria-live="polite" aria-atomic="true"><div id="toastBox"></div></div>
<div class="confettiLayer" id="confettiLayer"></div>
<div class="fxOverlay" id="fxOverlay" aria-hidden="true">
  <canvas id="fxCanvas"></canvas>
  <div class="congrats" id="congrats"><div class="big">Congratulations!</div></div>
</div>

<script>
(function(){
  "use strict";

  // =========================
  // CONFIG (edit these 2 lines)
  // =========================
  const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY";

  const QZ = {
    courseTitle: "Course: Coding & Robotics",
    quizTitle: "Quiz: (100 Questions)",
    attemptTitle: "Attempt: Coding & Robotics MCQ (100 Questions)",
    instructions: "Rules: Silent work. No talking. Auto-submit when time runs out.",
    durationMinutes: 35,
    autosaveSeconds: 15,
    showReviewAfterSubmit: true,
  };

  const $ = (id) => document.getElementById(id);
  const KEY = "disa_quiz_100q_dynamic_v1";
  const esc = (s) => String(s).replace(/[&<>\"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));

  // Supabase client
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =========================
  // 100 QUESTIONS (generated, short)
  // =========================
  // Each item: [question, [A,B,C,D], correctIndex]
  const BANK = [
    ["What is an algorithm?", ["A computer","A step-by-step set of instructions","A robot","A mistake"], 1],
    ["A loop is used to‚Ä¶", ["Repeat instructions","Delete files","Turn off a computer","Open a website"], 0],
    ["Debugging means‚Ä¶", ["Finding and fixing mistakes","Making the screen brighter","Charging a laptop","Printing a page"], 0],
    ["Which is a block-coding tool for learners?", ["Scratch","PowerPoint","Calculator","Camera"], 0],
    ["An IF statement is used to‚Ä¶", ["Make a choice/decision","Print a document","Charge a device","Open the Start menu"], 0],
    ["What does CPU stand for?", ["Central Processing Unit","Computer Power Unit","Control Program User","Central Print Unit"], 0],
    ["typing.com helps you practise‚Ä¶", ["Typing","Drawing","Singing","Cooking"], 0],
    ["Which key makes a space?", ["Spacebar","Tab","Caps Lock","Esc"], 0],
    ["Which key deletes to the LEFT?", ["Backspace","Delete","Enter","Windows"], 0],
    ["Typing speed is usually measured in‚Ä¶", ["WPM","KM","Volts","Pixels"], 0],
    ["Which shortcut saves in many apps?", ["Ctrl + S","Ctrl + P","Ctrl + C","Ctrl + V"], 0],
    ["Windows is a(n)‚Ä¶", ["Operating system","Browser","Game","Keyboard"], 0],
    ["A browser is used to‚Ä¶", ["Visit websites","Charge devices","Write with a pen","Build robots"], 0],
    ["Which is a browser?", ["Google Chrome","Windows","Keyboard","Touchpad"], 0],
    ["A password should be‚Ä¶", ["Kept private","Shared with friends","Written on the desk","Very short"], 0],
    ["The touchpad controls the‚Ä¶", ["Pointer/cursor","Speaker","Battery","Keyboard lights"], 0],
    ["A folder is used to‚Ä¶", ["Organise files","Play music","Charge the laptop","Change passwords"], 0],
    ["Wi-Fi is used to‚Ä¶", ["Connect to the internet","Charge the battery","Make the screen bigger","Type faster"], 0],
    ["Sphero is a‚Ä¶", ["Programmable robot ball","Printer","Keyboard","Monitor"], 0],
    ["Bluetooth is used for‚Ä¶", ["Short-range wireless connection","Printing","Charging","Typing"], 0],
    ["A sensor helps a robot‚Ä¶", ["Detect things","Eat","Sleep","Write"], 0],
    ["Robots follow‚Ä¶", ["Instructions","Feelings","Luck","Noise"], 0],
    ["In a flowchart, a diamond usually means‚Ä¶", ["Decision","Start","End","Data"], 0],
    ["A variable is like a‚Ä¶", ["Box that stores information","Type of printer","Mouse pointer","Battery"], 0],
    ["Which is hardware?", ["Keyboard","Windows","Website","Typing.com"], 0],
  ];

  // Turn ~25 base items into 100 by cycling and adding small ‚Äúcontext tags‚Äù
  function build100Questions() {
    const tags = [
      "Coding", "Robotics", "Digital Skills", "Computer Lab", "Sphero", "Typing", "Windows",
      "Internet Safety", "Problem Solving", "Algorithms"
    ];
    const out = [];
    for (let i = 0; i < 100; i++) {
      const base = BANK[i % BANK.length];
      const tag = tags[i % tags.length];
      // Keep it readable, but distinct
      const t = `[${tag}] ${base[0]}`;
      out.push({ t, o: [...base[1]], a: base[2] });
    }
    return out;
  }

  // =========================
  // Seeded shuffle (stops ‚Äúall A‚Äù)
  // =========================
  function hashStr(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
  function shuffleInPlace(arr,rng){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

  // =========================
  // STATE
  // =========================
  let QUESTIONS = build100Questions();
  $("totalQ").textContent = String(QUESTIONS.length);

  let S = { c:0, r: QZ.durationMinutes*60, A:{}, F:{}, L:false, seed:null };
  let T = null;

  // =========================
  // SUPABASE DROPDOWNS
  // =========================
  async function loadClasses(){
    const classSelect = $("classSelect");
    classSelect.innerHTML = `<option value="">Select class...</option>`;

    // Pull and dedupe
    const { data, error } = await supabase
      .from("learners")
      .select("class_name, grade")
      .order("grade", { ascending: true })
      .order("class_name", { ascending: true });

    if (error) { console.error(error); return; }

    const seen = new Set();
    for (const row of (data || [])) {
      if (!row.class_name) continue;
      const key = `${row.grade}|${row.class_name}`;
      if (seen.has(key)) continue;
      seen.add(key);
      const opt = document.createElement("option");
      opt.value = row.class_name;
      opt.textContent = row.class_name;
      opt.dataset.grade = row.grade ?? "";
      classSelect.appendChild(opt);
    }
  }

  async function loadLearnersForClass(className){
    const learnerSelect = $("learnerSelect");
    learnerSelect.disabled = true;
    learnerSelect.innerHTML = `<option value="">Loading...</option>`;
    $("gradeLine").textContent = `Grade: ‚Äî`;

    const { data, error } = await supabase
      .from("learners")
      .select("id, full_name, first_name, surname, grade, class_name")
      .eq("class_name", className)
      .order("surname", { ascending:true })
      .order("first_name", { ascending:true });

    if (error) {
      console.error(error);
      learnerSelect.innerHTML = `<option value="">Failed to load learners</option>`;
      return;
    }

    learnerSelect.innerHTML = `<option value="">Select learner...</option>`;
    for (const L of (data || [])) {
      const opt = document.createElement("option");
      opt.value = L.id;
      opt.textContent = L.full_name || `${L.first_name||""} ${L.surname||""}`.trim();
      opt.dataset.grade = L.grade ?? "";
      opt.dataset.className = L.class_name ?? "";
      opt.dataset.fullName = opt.textContent;
      learnerSelect.appendChild(opt);
    }
    learnerSelect.disabled = false;

    if (data && data[0]) $("gradeLine").textContent = `Grade: ${data[0].grade ?? "‚Äî"}`;
  }

  function hookDropdowns(){
    $("classSelect").addEventListener("change", async () => {
      const cls = $("classSelect").value;
      $("className").value = cls;
      $("learnerName").value = "";
      $("learnerSelect").value = "";
      if (!cls) {
        $("learnerSelect").disabled = true;
        $("learnerSelect").innerHTML = `<option value="">Select learner...</option>`;
        $("gradeLine").textContent = `Grade: ‚Äî`;
        save();
        return;
      }
      await loadLearnersForClass(cls);
      save();
    });

    $("learnerSelect").addEventListener("change", () => {
      const opt = $("learnerSelect").selectedOptions[0];
      if (!opt) return;
      $("learnerName").value = opt.dataset.fullName || "";
      $("className").value = opt.dataset.className || $("classSelect").value || "";
      $("gradeLine").textContent = `Grade: ${opt.dataset.grade || "‚Äî"}`;
      save();
    });
  }

  // =========================
  // QUIZ CORE
  // =========================
  function ensureSeed(){
    if (S.seed != null) return;
    const n = ($("learnerName").value || "").trim();
    const c = ($("className").value || "").trim();
    const base = (n && c) ? (n + "|" + c) : "anon";
    S.seed = hashStr(base + "|" + KEY);
  }

  function shuffleOptionsDeterministic(){
    ensureSeed();
    const rng = mulberry32(S.seed);
    for (const q of QUESTIONS) {
      const tagged = q.o.map((text, idx) => ({text, idx}));
      shuffleInPlace(tagged, rng);
      q.o = tagged.map(x => x.text);
      q.a = tagged.findIndex(x => x.idx === q.a);
    }
  }

  function nav(){
    const h = $("navGrid");
    h.innerHTML = "";
    for (let i=0;i<QUESTIONS.length;i++){
      const b = document.createElement("button");
      b.className = "qbtn todo";
      b.textContent = i+1;
      b.type = "button";
      b.addEventListener("click", () => {
        if (S.L) return;
        S.c = i;
        render();
        navUI();
      });
      h.appendChild(b);
    }
  }

  function render(){
    const q = QUESTIONS[S.c];
    const sel = S.A[S.c];
    const fl = !!S.F[S.c];

    $("qcard").innerHTML = `
      <div class="qhead">
        <div>
          <div class="qnum">Question ${S.c+1} of ${QUESTIONS.length}</div>
          <div class="qtext">${esc(q.t)}</div>
        </div>
        <div class="qpts">1 mark</div>
      </div>
      <div class="qbody">
        ${q.o.map((o, idx) => {
          const id = `q_${S.c}_opt_${idx}`;
          return `
            <label class="opt" for="${id}">
              <input ${(sel===idx)?"checked":""} ${S.L?"disabled":""}
                     type="radio" id="${id}" name="q_${S.c}" value="${idx}"/>
              <span>${esc(o)}</span>
            </label>
          `;
        }).join("")}
      </div>
    `;

    const fb = $("flagBtn");
    fb.classList.toggle("flagged", fl);
    fb.textContent = fl ? "‚öë Flagged" : "‚öë Flag question";

    $("prevBtn").disabled = S.L || S.c===0;
    $("nextBtn").disabled = S.L || S.c===QUESTIONS.length-1;
  }

  function navUI(){
    const bs = Array.from($("navGrid").children);
    for (let i=0;i<bs.length;i++){
      const b = bs[i];
      b.classList.remove("todo","done","flag","current");
      (S.A[i]!==undefined ? b.classList.add("done") : b.classList.add("todo"));
      if (S.F[i]) b.classList.add("flag");
      if (i===S.c) b.classList.add("current");
      b.disabled = S.L;
    }
    $("classSelect").disabled = S.L;
    $("learnerSelect").disabled = S.L;

    $("submitBtn").textContent = S.L ? "Submitted" : "Submit all and finish";
  }

  function unansweredCount(){
    let n=0;
    for (let i=0;i<QUESTIONS.length;i++) if (S.A[i]===undefined) n++;
    return n;
  }

  function idOK(){
    const name = ($("learnerName").value || "").trim();
    const cls  = ($("className").value || "").trim();
    if (!cls) { alert("Please select your class."); $("classSelect").focus(); return false; }
    if (!name) { alert("Please select your learner name."); $("learnerSelect").focus(); return false; }
    return true;
  }

  function score(){
    let e=0;
    const br=[];
    for (let i=0;i<QUESTIONS.length;i++){
      const q = QUESTIONS[i];
      const sel = S.A[i];
      const ok = sel === q.a;
      if (ok) e++;
      br.push([i, ok, sel, q.a]);
    }
    return { e, t: QUESTIONS.length, br };
  }

  // =========================
  // CELEBRATIONS
  // =========================
  const rnd = (a,b)=>a+Math.random()*(b-a);

  function showToast({e,t,pct,auto,perfect,name,cls}){
    const box = $("toastBox");
    box.innerHTML = "";
    const pass = pct>=50;
    const toast = document.createElement("div");
    toast.className = "toast toast-enter";
    const emoji = perfect ? "üèÜ" : (pass ? "‚úÖ" : "üß†");
    const status = perfect ? "PERFECT!" : (pass ? "PASS" : "NOT YET");

    toast.innerHTML = `
      <div class="emoji">${emoji}</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <p class="tTitle" style="margin:0">Quiz submitted</p>
          <span class="pill ${pass?"ok":"bad"}">${status}</span>
        </div>
        <div class="tMeta" style="margin-top:2px"><strong>${esc(name)}</strong> <span style="opacity:.6">‚Ä¢</span> <strong>${esc(cls)}</strong></div>
        <p class="tMeta">${auto ? "Time is up ‚Äî your attempt was auto-submitted." : "Submitted successfully."}</p>
        <div class="tScore">Score: <strong>${e}/${t}</strong> ‚Ä¢ <strong>${pct}%</strong></div>
        ${perfect ? "" : `<div class="tMeta" style="margin-top:6px">Try again to improve your mark!</div>`}
      </div>
      <button class="ghost" id="toastClose" style="margin-left:auto">Close</button>
    `;
    box.appendChild(toast);

    const btn = toast.querySelector("#toastClose");
    btn && btn.addEventListener("click", () => {
      toast.classList.add("toast-blur-exit");
      setTimeout(()=>toast.remove(), 350);
    });
  }

  function confettiBurst(){
    const cl = $("confettiLayer");
    cl.innerHTML = "";
    const n = 140;
    for (let i=0;i<n;i++){
      const p = document.createElement("div");
      p.className = "confettiPiece";
      p.style.left = rnd(0,100)+"vw";
      p.style.setProperty("--delay", rnd(0,0.6)+"s");
      p.style.setProperty("--dur", rnd(2.8,4.2)+"s");
      p.style.background = ["#b11226","#ffd24a","#1b7f3b","#0b2d4c","#ffffff"][i%5];
      p.style.width = rnd(7,12)+"px";
      p.style.height = rnd(10,18)+"px";
      cl.appendChild(p);
    }
    setTimeout(()=>{ cl.innerHTML=""; }, 5200);
  }

  function fireworksShow(ms=10000){
    const ov = $("fxOverlay"), cv = $("fxCanvas"), cg = $("congrats");
    ov.classList.add("show"); ov.setAttribute("aria-hidden","false");
    cg && cg.classList.add("rise");

    const ctx = cv.getContext("2d");
    let w=0,h=0;
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const resize = () => {
      w = ov.clientWidth; h = ov.clientHeight;
      cv.width = Math.floor(w*dpr); cv.height = Math.floor(h*dpr);
      cv.style.width=w+"px"; cv.style.height=h+"px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    };
    resize();
    window.addEventListener("resize", resize, {passive:true});

    let parts=[];
    const makeBurst = () => {
      const x=rnd(w*0.15,w*0.85), y=rnd(h*0.12,h*0.45);
      const count=46;
      const base=["#ffd24a","#ff6b6b","#6bcBef","#a29bfe","#55efc4","#ffffff"];
      for(let i=0;i<count;i++){
        const ang=rnd(0,Math.PI*2), spd=rnd(1.2,4.2), life=rnd(40,90);
        parts.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,life,max:life,c:base[(i+Math.floor(rnd(0,6)))%base.length],r:rnd(1.2,2.6)});
      }
    };

    let last=0, acc=0, running=true;
    const step = (ts) => {
      if(!last) last=ts;
      const dt=Math.min(32, ts-last); last=ts; acc+=dt;

      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="rgba(0,0,0,.14)";
      ctx.fillRect(0,0,w,h);

      for(let i=parts.length-1;i>=0;i--){
        const p=parts[i];
        p.life -= dt/16;
        p.vy += 0.06;
        p.x += p.vx; p.y += p.vy;
        const k = p.life/p.max;
        if(k<=0 || p.y>h+40 || p.x<-40 || p.x>w+40){ parts.splice(i,1); continue; }
        ctx.globalAlpha = Math.max(0,k);
        ctx.beginPath();
        ctx.fillStyle=p.c;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.globalAlpha=1;

      if(acc>520){ acc=0; makeBurst(); }
      if(running) requestAnimationFrame(step);
    };

    makeBurst(); makeBurst(); requestAnimationFrame(step);

    setTimeout(()=>{
      running=false;
      window.removeEventListener("resize", resize);
      ov.classList.remove("show"); ov.setAttribute("aria-hidden","true");
      cg && cg.classList.remove("rise");
      ctx.clearRect(0,0,w,h);
    }, ms);
  }

  function celebrate({e,t,pct,auto,name,cls}){
    const perfect = pct===100;
    confettiBurst();
    showToast({e,t,pct,auto,perfect,name,cls});
    if(perfect) setTimeout(()=>fireworksShow(10000), 300);
  }

  // =========================
  // STORAGE + TIMER
  // =========================
  function save(){
    const payload = {
      i: { learnerName: $("learnerName").value, className: $("className").value, classSel: $("classSelect").value, learnerSel: $("learnerSelect").value, gradeLine: $("gradeLine").textContent },
      s: { c:S.c, r:S.r, A:S.A, F:S.F, L:S.L, seed:S.seed }
    };
    localStorage.setItem(KEY, JSON.stringify(payload));
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      if(d.i){
        $("learnerName").value = d.i.learnerName || "";
        $("className").value = d.i.className || "";
        $("gradeLine").textContent = d.i.gradeLine || "Grade: ‚Äî";
      }
      if(d.s){
        S.c = Number.isFinite(d.s.c) ? d.s.c : 0;
        S.r = Number.isFinite(d.s.r) ? d.s.r : S.r;
        S.A = d.s.A || {};
        S.F = d.s.F || {};
        S.L = !!d.s.L;
        S.seed = d.s.seed ?? null;
      }
    }catch(e){}
  }

  function stop(){ if(T){ clearInterval(T); T=null; } }

  function tUI(){
    const m = String(Math.floor(S.r/60)).padStart(2,"0");
    const s = String(S.r%60).padStart(2,"0");
    $("timer").textContent = `${m}:${s}`;
    const p = $("timerPill");
    p.classList.remove("warn","danger");
    if(S.r<=300) p.classList.add("warn");
    if(S.r<=60) p.classList.add("danger");
  }

  function start(){
    if(T || S.L) return;
    T = setInterval(()=>{
      if(S.L) return;
      S.r = Math.max(0, S.r-1);
      tUI();
      if(S.r % QZ.autosaveSeconds === 0) save();
      if(S.r === 0) submit(true);
    }, 1000);
  }

  function reset(){
    try{ localStorage.removeItem(KEY); }catch(e){}
    stop();
    S = { c:0, r: QZ.durationMinutes*60, A:{}, F:{}, L:false, seed:null };
    $("result").style.display="none";
    $("result").innerHTML="";
    $("toastBox").innerHTML="";
    $("confettiLayer").innerHTML="";
    $("learnerName").value="";
    $("className").value="";
    $("gradeLine").textContent="Grade: ‚Äî";
    $("classSelect").value="";
    $("learnerSelect").innerHTML=`<option value="">Select learner...</option>`;
    $("learnerSelect").disabled=true;

    QUESTIONS = build100Questions();
    $("totalQ").textContent = String(QUESTIONS.length);

    nav(); render(); navUI(); tUI(); start(); save();
  }

  // =========================
  // SUBMIT
  // =========================
  function submit(auto=false){
    if(S.L) return;
    if(!idOK()) return;

    // IMPORTANT: seed shuffle AFTER learner chosen, so each learner gets stable shuffle
    if(S.seed == null) shuffleOptionsDeterministic();

    S.L = true;
    stop();
    navUI(); render();

    const { e, t, br } = score();
    const pct = Math.round((e/t)*100);
    const pass = pct>=50;
    const name = ($("learnerName").value || "").trim();
    const cls  = ($("className").value || "").trim();

    celebrate({e,t,pct,auto,name,cls});

    let html = `
      <div class="score">
        <div>
          <div class="big">${esc(name)} (${esc(cls)}) ‚Äî ${e}/${t} ‚Ä¢ ${pct}%</div>
          <div class="small">${auto ? "Auto-submitted when time ended." : "Submitted."}</div>
        </div>
        <div class="badge ${pass?"ok":"bad"}">${pass?"PASS":"NOT YET"}</div>
      </div>
    `;

    if(QZ.showReviewAfterSubmit){
      html += `
        <details class="review" open>
          <summary>Review answers</summary>
          <ol class="review-list">
            ${br.map(b=>{
              const i=b[0], ok=b[1], sel=b[2], cor=b[3], q=QUESTIONS[i];
              const your = sel===undefined ? "No answer" : q.o[sel];
              const ca = q.o[cor];
              return `
                <li>
                  <div><strong>${esc(q.t)}</strong> <span class="${ok?"correct":"wrong"}">(${ok?"Correct":"Incorrect"})</span></div>
                  <div>Your a: ${esc(String(your))}</div>
                  ${ok ? "" : `<div>Correct a: <span class="correct">${esc(String(ca))}</span></div>`}
                </li>
              `;
            }).join("")}
          </ol>
        </details>
      `;
    }

    $("result").innerHTML = html;
    $("result").style.display = "block";
    save();
    $("result").scrollIntoView({behavior:"smooth", block:"start"});
  }

  // =========================
  // EVENTS
  // =========================
  function bind(){
    document.addEventListener("change", (e)=>{
      if(S.L) return;
      const t = e.target;
      if(t && t.matches('input[type="radio"][name^="q_"]')){
        const qi = +t.name.split("_")[1];
        S.A[qi] = +t.value;
        navUI(); save();
      }
    });

    $("prevBtn").addEventListener("click", ()=>{ if(S.L||S.c===0) return; S.c--; render(); navUI(); save(); });
    $("nextBtn").addEventListener("click", ()=>{ if(S.L||S.c===QUESTIONS.length-1) return; S.c++; render(); navUI(); save(); });
    $("flagBtn").addEventListener("click", ()=>{ if(S.L) return; S.F[S.c]=!S.F[S.c]; render(); navUI(); save(); });
    $("submitBtn").addEventListener("click", (e)=>{ e.preventDefault(); if(S.L) return; submit(false); });
    $("finishAttemptBtn").addEventListener("click", ()=>{
      if(S.L) return;
      const u = unansweredCount();
      const fl = Object.values(S.F).filter(Boolean).length;
      alert(`Finish attempt\n\nUnanswered: ${u}\nFlagged: ${fl}\n\nClick ‚ÄúSubmit all and finish‚Äù to submit.`);
    });
    $("saveBtn").addEventListener("click", ()=>{ if(S.L) return; save(); alert("Saved on this device."); });
    $("resetBtn").addEventListener("click", reset);
  }

  // =========================
  // INIT
  // =========================
  async function init(){
    try{
      $("courseTitle").textContent = QZ.courseTitle;
      $("quizTitle").textContent = QZ.quizTitle;
      $("mainTitle").textContent = QZ.attemptTitle;
      $("mainSub").textContent = QZ.instructions;

      load();

      // Always refresh questions (guarantees 100 even if storage got weird)
      QUESTIONS = build100Questions();
      $("totalQ").textContent = String(QUESTIONS.length);

      // Load dropdowns
      await loadClasses();
      hookDropdowns();

      nav();
      render();
      bind();
      navUI();
      tUI();
      start();

      // If class/learner were already saved, try restore dropdown selections
      const saved = JSON.parse(localStorage.getItem(KEY) || "{}");
      if(saved.i && saved.i.classSel){
        $("classSelect").value = saved.i.classSel;
        $("className").value = saved.i.classSel;
        await loadLearnersForClass(saved.i.classSel);
        if(saved.i.learnerSel){
          $("learnerSelect").value = saved.i.learnerSel;
          const opt = $("learnerSelect").selectedOptions[0];
          if(opt){
            $("learnerName").value = opt.dataset.fullName || "";
            $("gradeLine").textContent = `Grade: ${opt.dataset.grade || "‚Äî"}`;
          }
        }
      }

    }catch(e){
      console.error(e);
      const c=$("qcard");
      c.innerHTML = `
        <div class="qhead">
          <div>
            <div class="qnum">Teacher note: Quiz failed to load</div>
            <div class="qtext">A script error stopped the quiz from showing questions.</div>
          </div>
          <div class="qpts">Fix required</div>
        </div>
        <div class="qbody">
          <p class="small" style="margin:0">Open DevTools ‚Üí Console to see the error.</p>
        </div>
      `;
    }
  }

  window.addEventListener("DOMContentLoaded", init);
  window.__qz_submit = (auto) => submit(!!auto);
  window.__qz_reset = () => reset();
  window.__qz_state = () => ({locked:S.L, answered:Object.keys(S.A).length, remaining:S.r});
})();
</script>
</body>
</html>
