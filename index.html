<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disa ‚Ä¢ Coding & Robotics MCQ (100 Questions)</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f5f6f8;
      --surface:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#dde3ea;
      --brand:#b11226;   /* Disa red */
      --brand2:#8f0e1e;
      --ok:#1b7f3b;
      --flag:#b45309;
      --shadow:0 10px 26px rgba(17,24,39,.10);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .topbar{
      background:linear-gradient(90deg,var(--brand),#7f0b18);
      color:#fff; padding:14px 18px; display:flex; align-items:center; gap:16px;
      box-shadow:var(--shadow);
    }
    .logo{
      width:88px;height:88px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;
      overflow:hidden; flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .topmeta{flex:1}
    .topmeta .course{font-size:28px;font-weight:800;line-height:1.05}
    .topmeta .quiz{opacity:.95;margin-top:4px}
    .timerBox{
      display:flex;flex-direction:column;align-items:flex-end;gap:8px;min-width:180px
    }
    .pill{
      background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25);
      padding:10px 14px;border-radius:999px;font-weight:700;
    }
    .copyright{font-size:12px;opacity:.9}
    .divider{height:3px;background:#fff;opacity:.08}

    .wrap{max-width:1400px;margin:16px auto;padding:0 14px;display:grid;grid-template-columns:360px 1fr;gap:14px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .sidebar{padding:14px}
    .h1{font-size:20px;font-weight:800;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 12px}

    label{display:block;color:var(--muted);font-weight:700;font-size:13px;margin:12px 0 6px}
    select,input{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);outline:none;
      font-size:14px;background:#fff;
    }
    .smallrow{display:flex;gap:10px}
    .smallrow > div{flex:1}

    .legend{display:flex;gap:14px;align-items:center;margin:12px 0 10px;color:var(--muted);font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;border:1px solid var(--border)}
    .d0{background:#e5e7eb}
    .d1{background:var(--ok);border-color:rgba(0,0,0,.08)}
    .d2{background:var(--flag);border-color:rgba(0,0,0,.08)}
    .navgrid{
      border-top:1px solid var(--border);
      padding-top:12px;margin-top:12px;
      display:grid;grid-template-columns:repeat(10,1fr);gap:6px;
      max-height:240px;overflow:auto;
    }
    .qbtn{
      border:1px solid var(--border);
      background:#fff;border-radius:10px;padding:8px 0;font-size:12px;font-weight:800;
      cursor:pointer;
    }
    .qbtn.answered{background:rgba(27,127,59,.10);border-color:rgba(27,127,59,.25)}
    .qbtn.flagged{background:rgba(180,83,9,.12);border-color:rgba(180,83,9,.28)}
    .qbtn.active{outline:3px solid rgba(177,18,38,.20);border-color:rgba(177,18,38,.35)}

    .sideActions{display:flex;gap:10px;margin-top:12px}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:800;cursor:pointer;
    }
    .btn.red{border-color:rgba(177,18,38,.35);color:var(--brand)}
    .main{padding:14px}
    .titleRow{padding:14px;border-bottom:1px solid var(--border)}
    .titleRow h2{margin:0;font-size:22px}
    .titleRow p{margin:6px 0 0;color:var(--muted)}
    .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:14px;border-bottom:1px solid var(--border)
    }
    .controls .spacer{flex:1}
    .btn.big{padding:10px 14px}
    .btn.brand{background:var(--brand);color:#fff;border-color:transparent}
    .btn.brand:hover{background:var(--brand2)}
    .content{padding:14px;min-height:420px}
    .qhead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-bottom:10px}
    .qno{font-weight:900}
    .qtext{font-size:18px;font-weight:800}
    .metaLine{color:var(--muted);font-size:12px;margin-top:4px}
    .choices{display:grid;gap:10px;margin-top:12px}
    .choice{
      border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;display:flex;gap:10px;align-items:flex-start;
    }
    .choice input{width:auto;margin-top:2px}
    .choice.selected{border-color:rgba(177,18,38,.35);background:rgba(177,18,38,.06)}
    .notice{
      padding:10px 12px;border-radius:12px;border:1px dashed rgba(177,18,38,.30);
      background:rgba(177,18,38,.06); color:var(--brand); font-weight:800; font-size:13px;
      margin:10px 0 0;
    }
    .resultBox{
      margin-top:14px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;
    }
    .resultBox .score{font-size:22px;font-weight:900}
    .resultBox .small{color:var(--muted)}
    .foot{padding:10px 14px;color:var(--muted);font-size:12px;border-top:1px solid var(--border)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="logo">
      <!-- Replace with your local file path if needed -->
      <img src="disa-logo.png" alt="Disa Primary School Logo" onerror="this.style.display='none'">
    </div>
    <div class="topmeta">
      <div class="course">Course: Coding & Robotics</div>
      <div class="quiz">Quiz: (100 Questions)</div>
    </div>
    <div class="timerBox">
      <div class="pill">Time left&nbsp;&nbsp;<span id="timeLeft">35:00</span></div>
      <div class="copyright">¬© MR SAMUELS</div>
    </div>
  </div>
  <div class="divider"></div>

  <div class="wrap">
    <!-- SIDEBAR -->
    <div class="card sidebar">
      <div class="h1">Quiz navigation</div>
      <p class="sub"><b>Total:</b> 100 questions ‚Ä¢ Auto-submit at 0</p>

      <label for="classSelect">Class</label>
      <select id="classSelect">
        <option value="">Select class...</option>
      </select>

      <label for="learnerSelect">Learner</label>
      <select id="learnerSelect" disabled>
        <option value="">Select learner...</option>
      </select>

      <div class="smallrow">
        <div>
          <label>Grade</label>
          <div style="padding:12px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-weight:900" id="gradeView">‚Äî</div>
        </div>
        <div>
          <label>Class</label>
          <input id="classBox" placeholder="e.g., 7B" />
        </div>
      </div>

      <label>Learner name</label>
      <input id="learnerBox" placeholder="e.g., A. Smith" />

      <div class="legend">
        <span><span class="dot d0"></span>Not answered</span>
        <span><span class="dot d1"></span>Answered</span>
        <span><span class="dot d2"></span>Flagged</span>
      </div>

      <div class="navgrid" id="navGrid"></div>

      <div class="sideActions">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn red" id="resetBtn">Reset</button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="card">
      <div class="titleRow">
        <h2>Attempt: Coding & Robotics MCQ (100 Questions)</h2>
        <p>Rules: Silent work. No talking. Auto-submit when time runs out.</p>
      </div>

      <div class="controls">
        <button class="btn big" id="prevBtn">Previous</button>
        <button class="btn big" id="nextBtn">Next</button>
        <button class="btn big" id="flagBtn">üèÅ Flag question</button>
        <div class="spacer"></div>
        <button class="btn big" id="finishBtn">Finish attempt</button>
        <button class="btn big brand" id="submitBtn">Submit all and finish</button>
      </div>

      <div class="content" id="content"></div>
      <div class="foot">Prepared by Mr Samuels</div>
    </div>
  </div>

<script>
/* =========================
   SUPABASE CONFIG
   ========================= */
const SUPABASE_URL = "https://tcofqcoeqptjdjawgohb.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_3ud-FlpJ9AZZDIzVkZ1EoA_B7c-Vs7B";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   QUIZ DATA (100 generated)
   Keep it short but stable.
   ========================= */
function buildQuestions(){
  const templates = [
    {q:"What does a robot use to detect distance?", a:["Speaker","Ultrasonic sensor","Keyboard","Printer"], c:1},
    {q:"In Scratch, a loop repeats code using which block type?", a:["Motion","Events","Control","Looks"], c:2},
    {q:"What does 'CPU' stand for?", a:["Central Processing Unit","Computer Power Unit","Core Print Utility","Central Program User"], c:0},
    {q:"Which is an INPUT device?", a:["Monitor","Speaker","Mouse","Projector"], c:2},
    {q:"Typing.com helps you improve:", a:["Drawing","Typing speed","Cooking","Swimming"], c:1},
    {q:"A 'program' is:", a:["A set of instructions","A type of battery","A robot wheel","A screen"], c:0},
    {q:"Which is a safe password idea?", a:["123456","password","Long phrase + symbols","Your name"], c:2},
    {q:"What is a 'sensor'?", a:["A robot's brain","A device that detects/reads","A wheel","A charger"], c:1},
    {q:"Which is a common output?", a:["Microphone","Monitor","Mouse","Touchpad"], c:1},
    {q:"What does Wi-Fi allow?", a:["Printing only","Wireless internet connection","More battery","Bigger screen"], c:1},
  ];

  const q = [];
  for(let i=0;i<100;i++){
    const t = templates[i % templates.length];
    // small variation so questions aren't identical in text
    const num = i+1;
    q.push({
      id: num,
      text: t.q + " (Q" + num + ")",
      choices: t.a.slice(),
      correct: t.c
    });
  }
  return q;
}
const QUESTIONS = buildQuestions();

/* =========================
   STATE
   ========================= */
const state = {
  idx: 0,
  answers: Array(100).fill(null),   // store choice index
  flagged: Array(100).fill(false),
  submitted: false,
  secondsLeft: 35*60,
  timerId: null,
  learner: { full_name:"", class_name:"", grade:null }
};

const $ = (id)=>document.getElementById(id);

const content = $("content");
const navGrid = $("navGrid");
const timeLeftEl = $("timeLeft");

/* =========================
   NAV GRID
   ========================= */
function renderNav(){
  navGrid.innerHTML = "";
  for(let i=0;i<100;i++){
    const b = document.createElement("button");
    b.className = "qbtn";
    b.textContent = (i+1);

    if(state.answers[i] !== null) b.classList.add("answered");
    if(state.flagged[i]) b.classList.add("flagged");
    if(i === state.idx) b.classList.add("active");

    b.onclick = ()=>{ state.idx=i; renderAll(); };
    navGrid.appendChild(b);
  }
}

/* =========================
   QUESTION RENDER
   ========================= */
function renderQuestion(){
  const q = QUESTIONS[state.idx];

  const answered = state.answers[state.idx];
  const flagged = state.flagged[state.idx];

  const learnerOk = (state.learner.full_name && state.learner.class_name && state.learner.grade);

  content.innerHTML = `
    <div class="qhead">
      <div>
        <div class="qno">Question ${q.id} / 100</div>
        <div class="qtext">${escapeHtml(q.text)}</div>
        <div class="metaLine">${flagged ? "‚öë Flagged" : ""}</div>
      </div>
      <div style="text-align:right;color:var(--muted);font-weight:800;font-size:13px">
        ${learnerOk ? `Learner: ${escapeHtml(state.learner.full_name)} ‚Ä¢ ${escapeHtml(state.learner.class_name)} ‚Ä¢ Grade ${state.learner.grade}` : `Select class + learner to record details`}
      </div>
    </div>

    ${!learnerOk ? `<div class="notice">Please select a class and learner on the left. The quiz still works, but submission will be blocked until learner info is selected.</div>` : ""}

    <div class="choices" id="choices"></div>

    <div id="resultArea"></div>
  `;

  const choicesBox = $("choices");
  q.choices.forEach((choiceText, i)=>{
    const row = document.createElement("label");
    row.className = "choice" + (answered===i ? " selected":"");
    row.innerHTML = `
      <input type="radio" name="q" ${answered===i ? "checked":""} ${state.submitted ? "disabled":""}/>
      <div><b>${String.fromCharCode(65+i)}.</b> ${escapeHtml(choiceText)}</div>
    `;
    row.onclick = (e)=>{
      if(state.submitted) return;
      state.answers[state.idx] = i;
      renderAll();
    };
    choicesBox.appendChild(row);
  });

  if(state.submitted){
    renderResultBox();
  }
}

function renderResultBox(){
  const score = calcScore();
  const pct = Math.round((score/100)*100);
  $("resultArea").innerHTML = `
    <div class="resultBox">
      <div class="score">Score: ${score} / 100 (${pct}%)</div>
      <div class="small">Answered: ${countAnswered()} ‚Ä¢ Flagged: ${countFlagged()}</div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* =========================
   TIMER
   ========================= */
function fmtTime(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}

function startTimerIfNeeded(){
  if(state.timerId) return;
  state.timerId = setInterval(()=>{
    if(state.submitted) return;
    state.secondsLeft = Math.max(0, state.secondsLeft - 1);
    timeLeftEl.textContent = fmtTime(state.secondsLeft);
    if(state.secondsLeft === 0){
      submitAll("Time is up (auto-submit).");
    }
  },1000);
}

function renderTime(){
  timeLeftEl.textContent = fmtTime(state.secondsLeft);
}

/* =========================
   SCORING
   ========================= */
function calcScore(){
  let score = 0;
  for(let i=0;i<100;i++){
    if(state.answers[i] === QUESTIONS[i].correct) score++;
  }
  return score;
}
function countAnswered(){
  return state.answers.filter(v=>v!==null).length;
}
function countFlagged(){
  return state.flagged.filter(Boolean).length;
}

/* =========================
   SAVE / LOAD (localStorage)
   ========================= */
const LS_KEY = "disa_mcq_v1";

function saveAttempt(){
  const payload = {
    idx: state.idx,
    answers: state.answers,
    flagged: state.flagged,
    secondsLeft: state.secondsLeft,
    submitted: state.submitted,
    learner: state.learner,
    learnerBox: $("learnerBox").value,
    classBox: $("classBox").value
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
  alert("Saved.");
}

function loadAttempt(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const p = JSON.parse(raw);
    state.idx = p.idx ?? 0;
    state.answers = p.answers ?? state.answers;
    state.flagged = p.flagged ?? state.flagged;
    state.secondsLeft = p.secondsLeft ?? state.secondsLeft;
    state.submitted = !!p.submitted;
    state.learner = p.learner ?? state.learner;

    $("learnerBox").value = p.learnerBox || "";
    $("classBox").value = p.classBox || "";
  }catch(e){}
}

function resetAttempt(){
  if(!confirm("Reset this attempt?")) return;
  if(state.timerId){ clearInterval(state.timerId); state.timerId=null; }
  state.idx = 0;
  state.answers = Array(100).fill(null);
  state.flagged = Array(100).fill(false);
  state.submitted = false;
  state.secondsLeft = 35*60;
  state.learner = {full_name:"", class_name:"", grade:null};
  $("learnerBox").value = "";
  $("classBox").value = "";
  $("gradeView").textContent = "‚Äî";
  $("classSelect").value = "";
  $("learnerSelect").innerHTML = `<option value="">Select learner...</option>`;
  $("learnerSelect").disabled = true;
  localStorage.removeItem(LS_KEY);
  renderAll();
}

/* =========================
   SUBMIT
   ========================= */
function submitAll(reason){
  const learnerOk = (state.learner.full_name && state.learner.class_name && state.learner.grade);
  if(!learnerOk){
    alert("Please select class + learner first (left panel).");
    return;
  }

  state.submitted = true;
  renderAll();

  const score = calcScore();
  const pct = Math.round((score/100)*100);
  alert(`${reason || "Submitted."}\n\n${state.learner.full_name} (${state.learner.class_name})\nScore: ${score}/100 (${pct}%)\n\nTry again to improve your mark!`);
}

/* =========================
   BUTTONS
   ========================= */
$("prevBtn").onclick = ()=>{
  state.idx = Math.max(0, state.idx-1);
  renderAll();
};
$("nextBtn").onclick = ()=>{
  state.idx = Math.min(99, state.idx+1);
  renderAll();
};
$("flagBtn").onclick = ()=>{
  state.flagged[state.idx] = !state.flagged[state.idx];
  renderAll();
};
$("finishBtn").onclick = ()=>{
  const score = calcScore();
  const pct = Math.round((score/100)*100);
  alert(`So far:\nAnswered: ${countAnswered()}/100\nFlagged: ${countFlagged()}\nCurrent score if submitted now: ${score}/100 (${pct}%)`);
};
$("submitBtn").onclick = ()=> submitAll("Submitted by learner.");
$("saveBtn").onclick = saveAttempt;
$("resetBtn").onclick = resetAttempt;

/* =========================
   SUPABASE: LOAD DROPDOWNS
   Table expected: public.learners
   Columns: full_name, first_name, surname, class_name, grade
   ========================= */
async function loadClasses(){
  try{
    const { data, error } = await sb
      .from("learners")
      .select("class_name, grade")
      .order("class_name", { ascending: true });

    if(error) throw error;

    // unique by class_name
    const seen = new Set();
    const classes = [];
    (data || []).forEach(r=>{
      const cn = (r.class_name || "").trim();
      if(!cn || seen.has(cn)) return;
      seen.add(cn);
      classes.push({ class_name: cn, grade: r.grade });
    });

    const sel = $("classSelect");
    sel.innerHTML = `<option value="">Select class...</option>` + classes
      .map(c=>`<option value="${escapeHtml(c.class_name)}" data-grade="${c.grade ?? ""}">${escapeHtml(c.class_name)}</option>`)
      .join("");

  }catch(e){
    console.error(e);
    $("classSelect").innerHTML = `<option value="">(Could not load classes)</option>`;
  }
}

async function loadLearnersForClass(className){
  const lsel = $("learnerSelect");
  lsel.disabled = true;
  lsel.innerHTML = `<option value="">Loading...</option>`;

  try{
    const { data, error } = await sb
      .from("learners")
      .select("id, full_name, class_name, grade")
      .eq("class_name", className)
      .order("full_name", { ascending: true });

    if(error) throw error;

    lsel.innerHTML = `<option value="">Select learner...</option>` + (data||[])
      .map(r=>`<option value="${r.id}" data-full="${escapeHtml(r.full_name||"")}" data-class="${escapeHtml(r.class_name||"")}" data-grade="${r.grade ?? ""}">${escapeHtml(r.full_name||"")}</option>`)
      .join("");

    lsel.disabled = false;
  }catch(e){
    console.error(e);
    lsel.innerHTML = `<option value="">(Could not load learners)</option>`;
    lsel.disabled = true;
  }
}

$("classSelect").addEventListener("change", async (e)=>{
  const className = e.target.value;
  $("classBox").value = className || "";
  const gradeAttr = e.target.selectedOptions?.[0]?.getAttribute("data-grade");
  $("gradeView").textContent = gradeAttr ? String(gradeAttr) : "‚Äî";

  state.learner = {full_name:"", class_name: className||"", grade: gradeAttr ? Number(gradeAttr) : null};
  $("learnerBox").value = "";

  if(!className){
    $("learnerSelect").innerHTML = `<option value="">Select learner...</option>`;
    $("learnerSelect").disabled = true;
    renderAll();
    return;
  }
  await loadLearnersForClass(className);
  renderAll();
});

$("learnerSelect").addEventListener("change", (e)=>{
  const opt = e.target.selectedOptions?.[0];
  if(!opt || !opt.value){
    state.learner.full_name = "";
    $("learnerBox").value = "";
    renderAll();
    return;
  }
  const full = opt.getAttribute("data-full") || "";
  const cls  = opt.getAttribute("data-class") || $("classBox").value || "";
  const grd  = opt.getAttribute("data-grade");

  state.learner = { full_name: full, class_name: cls, grade: grd ? Number(grd) : null };

  $("learnerBox").value = full;
  $("classBox").value = cls;
  $("gradeView").textContent = (grd ? String(grd) : "‚Äî");

  // Start timer once learner is selected
  startTimerIfNeeded();
  renderAll();
});

/* =========================
   MAIN RENDER
   ========================= */
function renderAll(){
  renderTime();
  renderNav();
  renderQuestion();
}

(function init(){
  loadAttempt();
  renderAll();
  loadClasses();
  // if learner already chosen, timer should run
  if(state.learner.full_name && !state.submitted) startTimerIfNeeded();
})();
</script>

</body>
</html>
